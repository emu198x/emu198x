# Commodore 64

## Overview

| Property | Value |
|----------|-------|
| CPU | MOS 6510 @ ~1 MHz |
| Crystal | 17.734475 MHz (PAL) / 14.318182 MHz (NTSC) |
| RAM | 64K |
| Video | VIC-II, 320×200 (160×200 multicolour) |
| Audio | SID 6581/8580, 3 voices + noise |
| Release | 1982 |

## Timing

### Crystal Derivation (PAL)

```
Crystal: 17.734475 MHz
   ÷18 → 985.248 kHz (CPU clock)
   ÷8  → 7.881875 MHz (dot clock)
```

### Crystal Derivation (NTSC)

```
Crystal: 14.318182 MHz
   ÷14 → 1.022727 MHz (CPU clock)
   Dot clock ≈ 8.18 MHz
```

### Frame Timing (PAL)

| Property | Value |
|----------|-------|
| CPU cycles per line | 63 |
| Lines per frame | 312 |
| CPU cycles per frame | 19656 |
| Frame rate | 50.125 Hz |

### Frame Timing (NTSC)

| Property | Value |
|----------|-------|
| CPU cycles per line | 65 |
| Lines per frame | 263 |
| CPU cycles per frame | 17095 |
| Frame rate | 59.826 Hz |

### VIC-II Timing

VIC-II runs at 8× CPU clock. Within each CPU cycle:
- First half: VIC-II accesses memory
- Second half: CPU accesses memory (if not stolen)

During **badlines**, VIC-II steals 40-43 cycles from CPU for character fetch.

### Phase Relationship

```
Crystal (PAL): |0|1|2|3|4|5|6|7|8|9|...|17|
VIC-II dot:    |*|.|*|.|*|.|*|.|*|.|...|*|   (every 2.25 ish)
CPU cycle:     |*|.|.|.|.|.|.|.|.|.|...|.|   (every 18)
```

The relationship is complex. For accurate emulation, tick at crystal frequency.

## Memory Map

### Default Configuration

| Address | Contents |
|---------|----------|
| $0000-$00FF | Zero page |
| $0100-$01FF | Stack |
| $0200-$9FFF | RAM |
| $A000-$BFFF | BASIC ROM (or RAM) |
| $C000-$CFFF | RAM |
| $D000-$DFFF | I/O or Character ROM or RAM |
| $E000-$FFFF | Kernal ROM (or RAM) |

### Banking via CPU Port ($01)

| Bit | Function |
|-----|----------|
| 0 | LORAM (0 = RAM at $A000) |
| 1 | HIRAM (0 = RAM at $E000) |
| 2 | CHAREN (0 = Char ROM at $D000, 1 = I/O) |

### VIC-II Bank Selection

CIA2 port A ($DD00) bits 0-1 select VIC-II's 16K view:

| Bits | Bank | Address Range |
|------|------|---------------|
| 11 | 0 | $0000-$3FFF |
| 10 | 1 | $4000-$7FFF |
| 01 | 2 | $8000-$BFFF |
| 00 | 3 | $C000-$FFFF |

## VIC-II (Video)

### Registers ($D000-$D02E)

| Address | Register |
|---------|----------|
| $D000-$D00F | Sprite X/Y positions |
| $D010 | Sprite X MSB |
| $D011 | Control register 1 |
| $D012 | Raster counter |
| $D013-$D014 | Light pen |
| $D015 | Sprite enable |
| $D016 | Control register 2 |
| $D017 | Sprite Y expand |
| $D018 | Memory pointers |
| $D019 | Interrupt register |
| $D01A | Interrupt enable |
| $D01B | Sprite priority |
| $D01C | Sprite multicolour |
| $D01D | Sprite X expand |
| $D01E | Sprite-sprite collision |
| $D01F | Sprite-background collision |
| $D020 | Border colour |
| $D021 | Background colour 0 |
| $D022-$D024 | Background colours 1-3 |
| $D025-$D026 | Sprite multicolour 0-1 |
| $D027-$D02E | Sprite colours |

### $D011 — Control Register 1

```
Bit 7: Raster bit 8
Bit 6: ECM (extended colour mode)
Bit 5: BMM (bitmap mode)
Bit 4: DEN (display enable)
Bit 3: RSEL (25/24 rows)
Bits 2-0: YSCROLL
```

### $D016 — Control Register 2

```
Bit 4: MCM (multicolour mode)
Bit 3: CSEL (40/38 columns)
Bits 2-0: XSCROLL
```

### Badlines

A badline occurs when:
- Display is enabled (DEN in $D011)
- Current raster line (low 3 bits) matches YSCROLL
- Raster is in range $30-$F7

During badlines, VIC-II steals cycles to fetch character pointers.

### Sprite DMA

Sprites steal 2 cycles each when enabled and visible:
- 1 cycle for pointer fetch
- 1 cycle for data fetch

Maximum steal: 8 sprites × 2 = 16 cycles.

## SID (Audio)

### Registers ($D400-$D41C)

Per-voice registers (×3 voices at $D400, $D407, $D40E):

| Offset | Register |
|--------|----------|
| +0, +1 | Frequency |
| +2, +3 | Pulse width |
| +4 | Control (waveform, gate, sync, ring) |
| +5 | Attack/Decay |
| +6 | Sustain/Release |

Global registers:

| Address | Register |
|---------|----------|
| $D415-$D416 | Filter cutoff |
| $D417 | Resonance, filter routing |
| $D418 | Volume, filter mode |

### Control Register (per voice)

```
Bit 7: Noise
Bit 6: Pulse
Bit 5: Sawtooth
Bit 4: Triangle
Bit 3: Test
Bit 2: Ring modulation
Bit 1: Sync
Bit 0: Gate
```

### 6581 vs 8580

| Feature | 6581 | 8580 |
|---------|------|------|
| Filter | Darker, varies by chip | Brighter, consistent |
| DC offset | Present | Minimal |
| Combined waveforms | Different response | Different response |

Many demos and games target specific SID revision.

## CIA (I/O)

Two CIA chips: CIA1 ($DC00) and CIA2 ($DD00).

### CIA1 — Keyboard and Joysticks

| Address | Function |
|---------|----------|
| $DC00 | Port A (keyboard column, joystick 2) |
| $DC01 | Port B (keyboard row, joystick 1) |
| $DC04-$DC05 | Timer A |
| $DC06-$DC07 | Timer B |
| $DC0D | Interrupt control |

### CIA2 — Serial, VIC Bank

| Address | Function |
|---------|----------|
| $DD00 | Port A (VIC bank, serial) |
| $DD04-$DD05 | Timer A |
| $DD06-$DD07 | Timer B |
| $DD0D | Interrupt control (triggers NMI) |

### Keyboard Matrix

8×8 matrix scanned by writing to $DC00 and reading $DC01.

## 1541 Disk Drive

The 1541 is a complete computer with its own 6502 CPU.

### Connection

Serial bus using ATN, CLK, DATA lines via CIA2.

### D64 Format

- 35 tracks
- 683 blocks (174,848 bytes usable)
- GCR encoded on real disk, D64 stores decoded

### Track Layout

| Tracks | Sectors | Bytes/Track |
|--------|---------|-------------|
| 1-17 | 21 | 5376 |
| 18-24 | 19 | 4864 |
| 25-30 | 18 | 4608 |
| 31-35 | 17 | 4352 |

Track 18 contains directory and BAM.

## Media Formats

### PRG Format

Raw program file:
- 2 bytes: Load address (little-endian)
- N bytes: Data

### D64 Format

Disk image, 174,848 bytes (standard) or 175,531 bytes (with error info).

### T64 Format

Tape archive, contains multiple files with metadata.

### TAP Format

Raw tape signal with pulse timings.

### CRT Format

Cartridge image with type and banking information.

## Verification Files

```
# Firmware
Commodore C64/Firmware/Commodore 64 - Kernal (1982)(Commodore).bin
Commodore C64/Firmware/Commodore 64 - BASIC (1982)(Commodore).bin
Commodore C64/Firmware/Commodore 64 - Character (1982)(Commodore).bin

# Games
Commodore C64/Games/Impossible Mission (1984)(Epyx).d64
Commodore C64/Games/Boulder Dash (1984)(First Star Software).d64
Commodore C64/Games/Elite (1985)(Firebird Software).d64

# Demos (timing sensitive)
Commodore C64/Demos/Crest - Deus Ex Machina (1994)(Crest).d64
```

## Common Pitfalls

1. **Badline timing** — Easy to get wrong, breaks many demos.
2. **Sprite DMA cycles** — Must steal from correct cycles.
3. **VIC-II bank vs CPU view** — They see memory differently.
4. **SID filter** — Hard to emulate accurately, chip-dependent.
5. **CIA timer edge cases** — Underflow behaviour matters.
6. **1541 timing** — Serial protocol is timing-sensitive.
