name: Amiga Phase1/2 Baseline

on:
  push:
    branches: ["main"]
  pull_request:
  workflow_dispatch:

jobs:
  amiga-baseline:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust build outputs
        uses: Swatinem/rust-cache@v2

      - name: Install Linux build deps for runner/frontends
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libasound2-dev \
            libudev-dev \
            libwayland-dev \
            libxkbcommon-dev \
            libx11-dev \
            libxcb1-dev \
            libxrandr-dev \
            libxi-dev \
            libxcursor-dev \
            libxinerama-dev

      - name: Core and chip crate unit tests
        run: |
          cargo test -p motorola-68000 --lib --quiet
          cargo test -p mos-cia-8520 --lib --quiet
          cargo test -p commodore-agnus-ocs --lib --quiet
          cargo test -p commodore-denise-ocs --lib --quiet
          cargo test -p commodore-paula-8364 --lib --quiet
          cargo test -p drive-amiga-floppy --lib --quiet

      - name: machine-amiga timing and DMA regressions
        run: |
          cargo test -p machine-amiga --test audio_paula --quiet
          cargo test -p machine-amiga --test blitter_timing --quiet
          cargo test -p machine-amiga --test disk_dma --quiet
          cargo test -p machine-amiga --test sprite_dma --quiet
          cargo test -p machine-amiga --test sprite_rendering --quiet

      - name: Runner compile and smoke tests
        run: |
          cargo check -p amiga-runner --quiet
          cargo test -p amiga-runner --quiet

      - name: Note on KS1.3 boot screenshot regression
        run: |
          echo "KS1.3 boot screenshot regression is intentionally not run in CI."
          echo "It requires a proprietary Kickstart ROM and is kept as a local/manual guard:"
          echo "  AMIGA_KS13_ROM=roms/kick13.rom cargo test -p machine-amiga --test boot_kickstart test_boot_kick13 -- --ignored"
